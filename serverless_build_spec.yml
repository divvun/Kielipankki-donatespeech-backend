version: 0.2

phases:
  install:
    runtime-versions:
      docker: 20
      nodejs: 20
      python: 3.11
    commands:
      - npm install -g serverless@3.38.0
      - npm install -g aws-cdk@2
  build:
    commands:
      - cd cdk
      - npm install
      - npm run build
      - echo Env variables Env $ENV branch $BRANCH
      - cdk bootstrap
      - cdk deploy RecorderBackendCI RecorderBackendResources RecorderWAF --require-approval=never
      - cd ../recorder-backend
      - npm install
      - sls create_domain --stage $ENV
      - sls deploy --stage $ENV
